name: macos-prep

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/macos-prep.yml"

jobs:
  fetch-macos-sdk:
    runs-on: macos-latest

    steps:
      - name: Install Xcode Command Line Tools
        run: |
          sudo xcode-select --install || true
          until xcode-select -p; do sleep 5; done

      - name: Locate SDK directory
        id: locate
        run: |
          SDK_DIR="/Library/Developer/CommandLineTools/SDKs"
          SDK=$(ls "$SDK_DIR" | grep -E '^MacOSX[0-9]+\.sdk$' | sort -V | tail -n1)

          echo "sdk_path=$SDK_DIR/$SDK" >> $GITHUB_OUTPUT
          echo "sdk_name=$SDK" >> $GITHUB_OUTPUT

      - name: Package macOS SDK tarball
        run: |
          mkdir -p out
          tar -cJf "out/MacOSX.sdk.tar.xz" -C "$(dirname "${{ steps.locate.outputs.sdk_path }}")" "${{ steps.locate.outputs.sdk_name }}"
          ls -lh out

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-sdk
          path: out/MacOSX.sdk.tar.xz
          retention-days: 14
